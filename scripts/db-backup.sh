#!/bin/bash

# ุณูุฑูุจุช ูุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงููููุงุช ุงููุฑููุนุฉ

# ุงูุชุงุฑูุฎ ุงูุญุงูู ุจุชูุณูู YYYY-MM-DD
DATE=$(date +"%Y-%m-%d")

# ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
BACKUP_DIR="./backups"
mkdir -p "$BACKUP_DIR"

# ุงุณู ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
DB_BACKUP_FILE="$BACKUP_DIR/db_backup_$DATE.sql"
FILES_BACKUP_FILE="$BACKUP_DIR/uploads_backup_$DATE.tar.gz"

# ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
echo "๐๏ธ ุฌุงุฑู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช..."

# ุงูุชุญูู ูู ูุฌูุฏ ูุชุบูุฑ DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
  # ูุญุงููุฉ ุงูุญุตูู ุนูู ูุชุบูุฑ DATABASE_URL ูู ููู .env
  if [ -f ".env" ]; then
    export $(grep -v '^#' .env | xargs)
  fi
  
  # ุงูุชุญูู ูุฑุฉ ุฃุฎุฑู
  if [ -z "$DATABASE_URL" ]; then
    echo "โ๏ธ ูุชุบูุฑ DATABASE_URL ุบูุฑ ููุฌูุฏ. ูุฑุฌู ุชุนูููู ูุจู ุชุดุบูู ูุฐุง ุงูุณูุฑูุจุช."
    exit 1
  fi
fi

# ุงุณุชุฎุฏุงู pg_dump ูุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
pg_dump "$DATABASE_URL" > "$DB_BACKUP_FILE"

# ุงูุชุญูู ูู ูุฌุงุญ ุงูุนูููุฉ
if [ $? -eq 0 ]; then
  echo "โ ุชู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ ูู: $DB_BACKUP_FILE"
else
  echo "โ ูุดู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช."
  exit 1
fi

# ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงููุฌูุฏุงุช ุงููุฑููุนุฉ
echo "๐ฆ ุฌุงุฑู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงููููุงุช ุงููุฑููุนุฉ..."

# ุงูุชุญูู ูู ูุฌูุฏ ูุฌูุฏ uploads
if [ -d "uploads" ]; then
  tar -czf "$FILES_BACKUP_FILE" uploads
  
  # ุงูุชุญูู ูู ูุฌุงุญ ุงูุนูููุฉ
  if [ $? -eq 0 ]; then
    echo "โ ุชู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงููููุงุช ุงููุฑููุนุฉ ุจูุฌุงุญ ูู: $FILES_BACKUP_FILE"
  else
    echo "โ ูุดู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงููููุงุช ุงููุฑููุนุฉ."
    exit 1
  fi
else
  echo "โ๏ธ ูุฌูุฏ uploads ุบูุฑ ููุฌูุฏ. ุชู ุชุฎุทู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงููููุงุช ุงููุฑููุนุฉ."
fi

# ุฅุธูุงุฑ ูุนูููุงุช ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
echo "๐ ุชูุช ุนูููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ุจูุฌุงุญ!"
echo "๐ ูุนูููุงุช ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ:"
echo "  - ุญุฌู ูุณุฎุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช: $(du -h "$DB_BACKUP_FILE" | cut -f1)"

if [ -f "$FILES_BACKUP_FILE" ]; then
  echo "  - ุญุฌู ูุณุฎุฉ ุงููููุงุช ุงููุฑููุนุฉ: $(du -h "$FILES_BACKUP_FILE" | cut -f1)"
fi

echo "๐ ูุฌูุฏ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ: $BACKUP_DIR"
echo ""
echo "๐ ูุงุณุชุนุงุฏุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช:"
echo "  psql \$DATABASE_URL < $DB_BACKUP_FILE"
echo ""
echo "๐ ูุงุณุชุนุงุฏุฉ ุงููููุงุช ุงููุฑููุนุฉ:"
echo "  tar -xzf $FILES_BACKUP_FILE"